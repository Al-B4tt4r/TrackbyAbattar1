<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Viewer Lokasi Teman</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }
    #map { height: 95vh; width: 100%; }
    h2 { text-align:center; margin:10px 0; color:#333; }
  </style>
</head>
<body>
  <h2>Live Locations Teman</h2>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ======= Firebase Config milikmu =======
    const firebaseConfig = {
      apiKey: "AIzaSyBffrwvdzVsGcFgjvhvc1FbeaXXJ43DcF8",
      authDomain: "my-project-c0014.firebaseapp.com",
      databaseURL: "https://my-project-c0014-default-rtdb.firebaseio.com",
      projectId: "my-project-c0014",
      storageBucket: "my-project-c0014.appspot.com",
      messagingSenderId: "1035321216653",
      appId: "1:1035321216653:web:cefac47b06ef39a90adcc4",
      measurementId: "G-G4PJ707CD6"
    };
    // ================================================

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Setup peta Leaflet
    const map = L.map('map').setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const markers = {}; // Simpan marker tiap visitor

    // Fungsi generate warna acak konsisten untuk tiap visitor
    function getColor(id){
      let hash = 0;
      for(let i=0;i<id.length;i++){ hash = id.charCodeAt(i)+((hash<<5)-hash); }
      const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
      return "#"+("00000"+c).slice(-6);
    }

    // Listen realtime database
    const ref = db.ref('locations');
    ref.on('value', snapshot => {
      const data = snapshot.val() || {};

      // Hapus marker lama
      Object.keys(markers).forEach(k => {
        map.removeLayer(markers[k]);
        delete markers[k];
      });

      // Tambah marker baru
      Object.keys(data).forEach(id => {
        const item = data[id];
        if (!item || !item.lat || !item.lon) return;

        const color = getColor(id);
        const icon = L.divIcon({
          className: "custom-marker",
          html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:2px solid #fff;"></div>`,
          iconSize: [24,24],
          iconAnchor: [12,12]
        });

        const marker = L.marker([item.lat, item.lon], {icon: icon})
          .addTo(map)
          .bindPopup(`
            <b>ID:</b> ${id}<br>
            <b>Accuracy:</b> ±${item.accuracy} m<br>
            <b>Timestamp:</b> ${new Date(item.ts).toLocaleString()}
          `);

        markers[id] = marker;
      });

      // Set view ke semua marker
      const ids = Object.keys(data);
      if(ids.length){
        const group = new L.featureGroup(ids.map(id=>markers[id]));
        map.fitBounds(group.getBounds().pad(0.3));
      }
    });
  </script>
</body>
</html>
